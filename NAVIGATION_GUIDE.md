# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–µ —á–∞–Ω–∫–æ–≤

## –û–±–∑–æ—Ä

–ü–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞–Ω–∫–æ–≤. –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω—É–∂–Ω–æ:
1. **–ü–µ—Ä–µ–π—Ç–∏** –∫ –Ω—É–∂–Ω–æ–º—É –º–µ—Å—Ç—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
2. **–ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å** –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
3. **–ü—Ä–æ—Å–∫—Ä–æ–ª–ª–∏—Ç—å** —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫ —á–∞–Ω–∫—É

–£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤, –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –∫ —Å–ª–æ–∂–Ω—ã–º.

---

## üéØ –ü–æ–¥—Ö–æ–¥ 1: Text Fragments API (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±!**

### –ß—Ç–æ —ç—Ç–æ?

Text Fragments API - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –±—Ä–∞—É–∑–µ—Ä–æ–≤, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ —Å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π** —Ç–µ–∫—Å—Ç–∞.

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

```javascript
// –£ –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π URL –≤ navigation.url
const navigationUrl = chunk.navigation.url;
// –ü—Ä–∏–º–µ—Ä: "https://confluence.../page#:~:text=–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ%20–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"

// –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º URL
window.location.href = navigationUrl;
// –ò–õ–ò
window.open(navigationUrl, '_blank');
```

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

1. ‚úÖ –ë—Ä–∞—É–∑–µ—Ä **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –Ω–∞—Ö–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
2. ‚úÖ **–°–∫—Ä–æ–ª–ª–∏—Ç** –∫ –Ω–µ–º—É
3. ‚úÖ **–ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç** —Ç–µ–∫—Å—Ç —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º —Ü–≤–µ—Ç–æ–º (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞)

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ –ù—É–ª–µ–≤–æ–π –∫–æ–¥ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Chrome, Edge, Safari (—Å –≤–µ—Ä—Å–∏–∏ 16.1)
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ DOM

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- ‚ö†Ô∏è Firefox –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
- ‚ö†Ô∏è –¶–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–µ–ª—å–∑—è –∫–∞—Å—Ç–æ–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- ‚ö†Ô∏è –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥

### –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞

```javascript
// React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
function SearchResult({ chunk }) {
  const handleClick = () => {
    // –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º URL —Å text fragment
    window.open(chunk.navigation.url, '_blank');
  };
  
  return (
    <div className="search-result" onClick={handleClick}>
      <h3>{chunk.page_title}</h3>
      <div className="breadcrumb">
        {chunk.text_heading_hierarchy.join(' > ')}
      </div>
      <p className="snippet">{chunk.normalized_text.substring(0, 200)}...</p>
    </div>
  );
}
```

**–í—ã–≤–æ–¥**: –î–ª—è 90% —Å–ª—É—á–∞–µ–≤ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ! ‚ú®

---

## üé® –ü–æ–¥—Ö–æ–¥ 2: Custom JavaScript Highlighting

**–ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π.**

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

- –ù—É–∂–µ–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ü–≤–µ—Ç/—Å—Ç–∏–ª—å –ø–æ–¥—Å–≤–µ—Ç–∫–∏
- –ù—É–∂–Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (–Ω–µ –∏—Å—á–µ–∑–∞—é—â–∞—è)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Firefox –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞
- Confluence –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–∞–∫, —á—Ç–æ –º–æ–∂–Ω–æ –≤–Ω–µ–¥—Ä–∏—Ç—å custom JS

### –í–∞—Ä–∏–∞–Ω—Ç 2.1: –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º XPath

```javascript
/**
 * –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞–Ω–∫—É –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º XPath
 */
function navigateToChunk(chunk) {
  const { xpath_start, text_length } = chunk.navigation;
  const searchText = chunk.normalized_text;
  
  // 1. –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ XPath
  const element = getElementByXPath(xpath_start);
  
  if (!element) {
    console.error('Element not found by XPath:', xpath_start);
    return;
  }
  
  // 2. –°–∫—Ä–æ–ª–ª–∏–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É
  element.scrollIntoView({ 
    behavior: 'smooth', 
    block: 'center' 
  });
  
  // 3. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
  highlightTextInElement(element, searchText);
}

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ XPath
 */
function getElementByXPath(xpath) {
  const result = document.evaluate(
    xpath,
    document,
    null,
    XPathResult.FIRST_ORDERED_NODE_TYPE,
    null
  );
  return result.singleNodeValue;
}

/**
 * –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —ç–ª–µ–º–µ–Ω—Ç–µ
 */
function highlightTextInElement(element, searchText) {
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
  const text = element.textContent;
  
  // –ò—â–µ–º —Ç–µ–∫—Å—Ç (–ø–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
  const searchFragment = searchText.substring(0, 100);
  const index = text.indexOf(searchFragment);
  
  if (index === -1) {
    console.warn('Text not found in element');
    return;
  }
  
  // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ span —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
  const innerHTML = element.innerHTML;
  const textToHighlight = text.substring(index, index + searchText.length);
  
  element.innerHTML = innerHTML.replace(
    textToHighlight,
    `<mark class="search-highlight">${textToHighlight}</mark>`
  );
  
  // –î–æ–±–∞–≤–ª—è–µ–º CSS –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  addHighlightStyles();
}

/**
 * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏
 */
function addHighlightStyles() {
  if (document.getElementById('search-highlight-styles')) return;
  
  const style = document.createElement('style');
  style.id = 'search-highlight-styles';
  style.textContent = `
    .search-highlight {
      background-color: #ffeb3b;
      padding: 2px 0;
      border-radius: 2px;
      animation: highlight-pulse 1s ease-in-out;
    }
    
    @keyframes highlight-pulse {
      0%, 100% { background-color: #ffeb3b; }
      50% { background-color: #ffc107; }
    }
  `;
  document.head.appendChild(style);
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2.2: –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CSS —Å–µ–ª–µ–∫—Ç–æ—Ä–∞

```javascript
/**
 * –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞–Ω–∫—É –∏—Å–ø–æ–ª—å–∑—É—è CSS —Å–µ–ª–µ–∫—Ç–æ—Ä
 */
function navigateToChunkBySelector(chunk) {
  const { css_selector_start } = chunk.navigation;
  const searchText = chunk.normalized_text;
  
  // 1. –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ CSS —Å–µ–ª–µ–∫—Ç–æ—Ä—É
  const element = document.querySelector(css_selector_start);
  
  if (!element) {
    console.error('Element not found by selector:', css_selector_start);
    return;
  }
  
  // 2. –°–∫—Ä–æ–ª–ª–∏–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É
  element.scrollIntoView({ 
    behavior: 'smooth', 
    block: 'center' 
  });
  
  // 3. –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
  highlightTextInElement(element, searchText);
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2.3: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —Å Mark.js

–ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É [Mark.js](https://markjs.io/) –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏:

```javascript
/**
 * –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Mark.js
 */
import Mark from 'mark.js';

function highlightChunkWithMarkJS(chunk) {
  const { css_selector_start } = chunk.navigation;
  const searchText = chunk.normalized_text;
  
  // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç
  const element = document.querySelector(css_selector_start);
  
  if (!element) return;
  
  // –°–∫—Ä–æ–ª–ª–∏–º
  element.scrollIntoView({ 
    behavior: 'smooth', 
    block: 'center' 
  });
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º Mark.js –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
  const markInstance = new Mark(element);
  
  // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 50 —Å–ª–æ–≤ —á–∞–Ω–∫–∞
  const wordsToHighlight = searchText.split(' ').slice(0, 50).join(' ');
  
  markInstance.mark(wordsToHighlight, {
    accuracy: 'partially',
    className: 'search-highlight',
    caseSensitive: false,
    separateWordSearch: false,
    done: function() {
      // –°–∫—Ä–æ–ª–ª–∏–º –∫ –ø–µ—Ä–≤–æ–º—É –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
      const firstMark = element.querySelector('.search-highlight');
      if (firstMark) {
        firstMark.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'center' 
        });
      }
    }
  });
}
```

---

## üîß –ü–æ–¥—Ö–æ–¥ 3: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (–ù–∞–∏–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–æ–≤ —Å fallback.**

```javascript
/**
 * –£–º–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è —Å fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏
 */
async function navigateToChunkSmart(chunk) {
  const { url, xpath_start, css_selector_start, highlight_metadata } = chunk.navigation;
  
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 1: Text Fragments API (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
  if (isTextFragmentsSupported()) {
    window.location.href = url;
    return;
  }
  
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 2: XPath
  let element = getElementByXPath(xpath_start);
  
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 3: CSS —Å–µ–ª–µ–∫—Ç–æ—Ä (fallback)
  if (!element) {
    element = document.querySelector(css_selector_start);
  }
  
  // –°—Ç—Ä–∞—Ç–µ–≥–∏—è 4: –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É (–ø–æ—Å–ª–µ–¥–Ω–∏–π fallback)
  if (!element) {
    element = findElementByText(highlight_metadata.text_fragment);
  }
  
  if (!element) {
    console.error('Could not locate chunk on page');
    // –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.location.href = chunk.navigation.url.split('#')[0];
    return;
  }
  
  // –ù–∞—à–ª–∏ —ç–ª–µ–º–µ–Ω—Ç - –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
  element.scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  highlightElement(element, chunk.normalized_text);
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Text Fragments API
 */
function isTextFragmentsSupported() {
  return 'fragmentDirective' in document;
}

/**
 * –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—É —Ç–µ–∫—Å—Ç–∞
 */
function findElementByText(textFragment) {
  const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    null
  );
  
  let node;
  while (node = walker.nextNode()) {
    if (node.textContent.includes(textFragment)) {
      return node.parentElement;
    }
  }
  
  return null;
}

/**
 * –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
 */
function highlightElement(element, text) {
  // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤–µ—Å—å —ç–ª–µ–º–µ–Ω—Ç
  element.classList.add('chunk-highlight-temp');
  
  // –ß–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
  setTimeout(() => {
    element.classList.remove('chunk-highlight-temp');
    highlightTextInElement(element, text);
  }, 1000);
}
```

**CSS –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏:**

```css
/* –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
.chunk-highlight-temp {
  outline: 3px solid #2196F3;
  outline-offset: 2px;
  background-color: rgba(33, 150, 243, 0.1);
  animation: pulse-border 1s ease-in-out;
}

@keyframes pulse-border {
  0%, 100% { outline-color: #2196F3; }
  50% { outline-color: #64B5F6; }
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
mark.search-highlight {
  background-color: #FFEB3B;
  color: #000;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 500;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  animation: highlight-fade-in 0.5s ease-in;
}

@keyframes highlight-fade-in {
  from {
    background-color: #FFC107;
    transform: scale(1.05);
  }
  to {
    background-color: #FFEB3B;
    transform: scale(1);
  }
}
```

---

## üé™ –ü–æ–¥—Ö–æ–¥ 4: Browser Extension / User Script

**–î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Confluence.**

–°–æ–∑–¥–∞–µ–º browser extension (Chrome/Firefox), –∫–æ—Ç–æ—Ä–æ–µ:

1. –°–ª—É—à–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —á–∞–Ω–∫–µ
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç
3. –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö Confluence

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Extension

```
confluence-highlighter/
‚îú‚îÄ‚îÄ manifest.json
‚îú‚îÄ‚îÄ content.js       # –°–∫—Ä–∏–ø—Ç, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö Confluence
‚îî‚îÄ‚îÄ background.js    # Background service worker
```

### manifest.json

```json
{
  "manifest_version": 3,
  "name": "Confluence Chunk Highlighter",
  "version": "1.0",
  "description": "Highlights search results in Confluence pages",
  
  "content_scripts": [
    {
      "matches": ["*://your-confluence-domain.com/*"],
      "js": ["content.js"],
      "run_at": "document_end"
    }
  ],
  
  "permissions": ["activeTab"]
}
```

### content.js

```javascript
/**
 * Content script –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —á–∞–Ω–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Confluence
 */
(function() {
  'use strict';
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ URL
  const params = new URLSearchParams(window.location.search);
  
  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å —Ç–∞–∫:
  // ?chunk_xpath=/html/body/div/p&chunk_text=–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ%20–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
  const chunkXPath = params.get('chunk_xpath');
  const chunkSelector = params.get('chunk_selector');
  const chunkText = params.get('chunk_text');
  
  if (!chunkXPath && !chunkSelector && !chunkText) {
    // –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞–Ω–∫–µ - –≤—ã—Ö–æ–¥–∏–º
    return;
  }
  
  // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', highlightChunk);
  } else {
    highlightChunk();
  }
  
  function highlightChunk() {
    let element = null;
    
    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç
    if (chunkXPath) {
      element = getElementByXPath(chunkXPath);
    }
    
    if (!element && chunkSelector) {
      element = document.querySelector(chunkSelector);
    }
    
    if (!element && chunkText) {
      element = findElementByText(chunkText);
    }
    
    if (!element) {
      console.warn('Could not find chunk element');
      return;
    }
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∏ —Å–∫—Ä–æ–ª–ª–∏–º
    scrollToAndHighlight(element, chunkText);
  }
  
  function scrollToAndHighlight(element, text) {
    // –°–∫—Ä–æ–ª–ª —Å –æ—Ç—Å—Ç—É–ø–æ–º –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    const yOffset = -100;
    const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;
    
    window.scrollTo({ top: y, behavior: 'smooth' });
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
    if (text) {
      highlightTextInElement(element, text);
    } else {
      // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤–µ—Å—å —ç–ª–µ–º–µ–Ω—Ç
      element.style.backgroundColor = '#FFEB3B';
      element.style.transition = 'background-color 2s ease-out';
      
      setTimeout(() => {
        element.style.backgroundColor = '';
      }, 2000);
    }
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏...
  function getElementByXPath(xpath) { /* ... */ }
  function findElementByText(text) { /* ... */ }
  function highlightTextInElement(element, text) { /* ... */ }
})();
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞

```javascript
// –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞
function openChunkInConfluence(chunk) {
  const baseUrl = chunk.navigation.url.split('#')[0];
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è extension
  const url = new URL(baseUrl);
  url.searchParams.set('chunk_xpath', chunk.navigation.xpath_start);
  url.searchParams.set('chunk_selector', chunk.navigation.css_selector_start);
  url.searchParams.set('chunk_text', chunk.navigation.highlight_metadata.text_fragment);
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
  window.open(url.toString(), '_blank');
}
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–æ–¥—Ö–æ–¥ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è | Browser Support |
|--------|-----------|------------|--------------|-----------------|
| Text Fragments | ‚≠ê –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê –ù–∏–∑–∫–∞—è | Chrome, Edge, Safari 16.1+ |
| Custom JS (XPath) | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –í—Å–µ –±—Ä–∞—É–∑–µ—Ä—ã |
| Custom JS (CSS) | ‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –í—Å–µ –±—Ä–∞—É–∑–µ—Ä—ã |
| Mark.js | ‚≠ê‚≠ê‚≠ê –°—Ä–µ–¥–Ω–µ | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | –í—Å–µ –±—Ä–∞—É–∑–µ—Ä—ã |
| –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π | ‚≠ê‚≠ê‚≠ê‚≠ê –°–ª–æ–∂–Ω–æ | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –í—Å–µ –±—Ä–∞—É–∑–µ—Ä—ã |
| Browser Extension | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê –û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | –¢—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ |

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ MVP:
‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Text Fragments API** (–ø–æ–¥—Ö–æ–¥ 1)
- –ù—É–ª–µ–≤–æ–π –∫–æ–¥
- –†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è 90% —Å–ª—É—á–∞–µ–≤

### –î–ª—è production —Å–∏—Å—Ç–µ–º—ã:
‚úÖ **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥** (–ø–æ–¥—Ö–æ–¥ 3)
- Text Fragments –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥
- Custom highlighting –∫–∞–∫ fallback
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤

### –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
‚úÖ **Browser Extension** (–ø–æ–¥—Ö–æ–¥ 4)
- –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
- –õ—É—á—à–∏–π UX
- –¢—Ä–µ–±—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

```javascript
function navigateWithLoader(chunk) {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
  showLoadingIndicator('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É...');
  
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
  const newWindow = window.open(chunk.navigation.url, '_blank');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É (–µ—Å–ª–∏ –≤ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ)
  if (newWindow) {
    const checkLoaded = setInterval(() => {
      try {
        if (newWindow.document.readyState === 'complete') {
          clearInterval(checkLoaded);
          hideLoadingIndicator();
        }
      } catch (e) {
        // Cross-origin - –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
        clearInterval(checkLoaded);
        hideLoadingIndicator();
      }
    }, 100);
  }
}
```

### 2. –ö–Ω–æ–ø–∫–∞ "–°–Ω—è—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É"

```javascript
// –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞–≤–∞—é—â—É—é –∫–Ω–æ–ø–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Confluence
function addClearHighlightButton() {
  const button = document.createElement('button');
  button.id = 'clear-highlight-btn';
  button.textContent = '‚úï –°–Ω—è—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É';
  button.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 9999;
    padding: 10px 20px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  `;
  
  button.onclick = () => {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    document.querySelectorAll('.search-highlight').forEach(el => {
      el.outerHTML = el.textContent;
    });
    button.remove();
  };
  
  document.body.appendChild(button);
}
```

### 3. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ø—Ä–µ–≤—å—é

```javascript
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —á–∞–Ω–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
function showChunkPreview(chunk) {
  const preview = document.createElement('div');
  preview.className = 'chunk-preview';
  preview.innerHTML = `
    <div class="preview-header">
      <span>${chunk.page_title}</span>
      <button onclick="this.parentElement.parentElement.remove()">‚úï</button>
    </div>
    <div class="preview-breadcrumb">
      ${chunk.text_heading_hierarchy.join(' > ')}
    </div>
    <div class="preview-content">
      ${chunk.normalized_text}
    </div>
    <div class="preview-actions">
      <button onclick="window.open('${chunk.navigation.url}', '_blank')">
        –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      </button>
    </div>
  `;
  
  document.body.appendChild(preview);
}
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Text Fragments –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
console.log('Text Fragments supported:', 'fragmentDirective' in document);

// –¢–µ—Å—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏
window.location.hash = ':~:text=–∫–∞–∫–æ–π-—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã';
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ XPath

```javascript
// –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ XPath –≤ –∫–æ–Ω—Å–æ–ª–∏
const xpath = '/html/body/div[2]/main/article/p[3]';
const result = document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null);
console.log('Element found:', result.singleNodeValue);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ CSS —Å–µ–ª–µ–∫—Ç–æ—Ä–∞

```javascript
const selector = 'div.content > article > p:nth-child(3)';
const element = document.querySelector(selector);
console.log('Element found:', element);
```

---

## üìù –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–ù–∞—á–Ω–∏—Ç–µ —Å Text Fragments API**, —ç—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±:

```javascript
// –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
function openSearchResult(chunk) {
  window.open(chunk.navigation.url, '_blank');
}
```

**–ó–∞—Ç–µ–º –¥–æ–±–∞–≤—å—Ç–µ fallback** –¥–ª—è –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏:

```javascript
// –° fallback
function openSearchResult(chunk) {
  if ('fragmentDirective' in document) {
    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã - Text Fragments
    window.open(chunk.navigation.url, '_blank');
  } else {
    // –°—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã - custom highlighting
    const url = chunk.navigation.url.split('#')[0];
    window.open(
      `${url}?highlight_xpath=${encodeURIComponent(chunk.navigation.xpath_start)}`,
      '_blank'
    );
  }
}
```

–≠—Ç–æ–≥–æ —Ö–≤–∞—Ç–∏—Ç –¥–ª—è –æ—Ç–ª–∏—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞! üéâ
